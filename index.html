<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="mixpanel-platform.min.js"></script>
    <script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" type="text/css" href="tooltips.css">
</head>

<body class="mixpanel-platform-body">

<div id="wrapper">
<div id="editor_wrapper">

    <div id="report_selector_menu">
        <strong>Example queries:</strong><div id="reports_dropdown"></div>
    </div>
    <a href="https://docs.google.com/document/d/1jc291Kn_CpH2xX99oA4BBkVrZhLr3Ylz2t15L3aiSOo/edit#heading=h.pfovx9s4ubs" id="docs" target="_blank">Documentation</a>

    <div id="editor">
</div> <!-- weird formatting required for default code to look good -->

    <div id="controls">
        <table id="params_table">
            <tr>
                <th>
                    Dates to query: <a href="#" data-tooltip="This controls the `from_date` and `to_date` api parameters. We will only read data between these dates (inclusive)"><img src="question_mark.png" class="tooltip_questionmark" /></a>
                </th>
                <td><div id="dates"></div></td>
            </tr>
            <tr>
                <th>Script params: <a href="#" data-tooltip="This is a global variable `params` that will be available to your script. This lets your scripts be flexible. For example, if you were writing Segmentation, you might add an 'event_name' parameter and filter for `if (event.name == params.event_name)` to your script."><img src="question_mark.png" class="tooltip_questionmark" /></a></th>
                <td><input type="text" id="script_params" /></td>
            </tr>
        </table>
        <button id="run_button">Run query</button>
        <div style="clear: both"></div>
    </div>
</div>

<br />

<div id="output"></div>
</div>

<script>
    $(document).ready(function() {
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/textmate");
        editor.getSession().setMode("ace/mode/javascript");
        editor.setOptions({
            maxLines: 20
        });

        $("#dates").MPDatepicker();

        var set_editor_contents = function(query_name) {
            var script = $("#" + query_name + "_query").html();
            var params = JSON.parse($("#" + query_name + "_params").html());

            editor.setValue($.trim(script), -1);
            var params_string = JSON.stringify(params.params);
            $("#script_params").val(params_string);
            $("#script_params").css('width', params_string.length * 8.3);

            $("#output").html('').css('visibility', 'hidden');
        };

        set_editor_contents("groupby");

        $("#reports_dropdown").MPSelect({
            items: [
                { 'value': 'groupby', 'label': 'Simple groupBy' },
                { 'value': 'top_email_providers', 'label': 'Top email providers' },
                { 'value': 'max_pixels', 'label': 'Max pixels' },
                { 'value': 'map_exception', 'label': 'map() exception' }
            ]
        });

        $("#reports_dropdown").change(function(e, val) {
            set_editor_contents(val);
        });

        function date_to_string(d) {
            return d.toISOString().split('T')[0];
        }

        function set_output(formatted) {
            $("#output").html(
                $("<pre>").html(formatted)
            );
        }

        $("#run_button").on('click', function() {
            // Show spinner while running query
            $("#output").html(
                $("<div class='spinner_wrapper'>").append(
                    $("<img src='ajax-loader-big.gif' />")
                )
            );
            $("#output").css('visibility', 'visible');

            // Make query
            var dates = $("#dates").val();
            var params = {
                "from_date": date_to_string(dates.from),
                "to_date": date_to_string(dates.to),
                "params": $("#script_params").val()
            };
            console.log(params)
            MP.api.custom_query(editor.getValue(), params)
                .done(function(resp) {
                    var stringified = JSON.stringify(resp, undefined, 2);
                    set_output(stringified);
                })
                .fail(function($xhr) {
                    set_output($xhr.error);
                });
        });
    });
</script>

<script type="text/cq" id="groupby_query">
function main() {
    return Events({})
    .filter(function(event) { return event["name"] == "$signup"; })
    .groupBy(['mp_country_code'], function(accumulators, items) {
        var ret = items.length;
        for (var i = 0; i < accumulators.length; ++i) {
            ret += accumulators[i];
        }
        return ret;
    });
}
</script>
<script type="text/cq" id="groupby_params">
{"params":{}}
</script>

<script type="text/cq" id="top_email_providers_query">
function main() {
    return Events({})
        .groupBy([function(event) {
                email = event["Email"];
                if (!email) return undefined;
                pos = email.indexOf('@');
                if (pos < 0) return undefined;
                return email.substr(pos + 1);
            }],
            function(accumulators, items) {
                var ret = items.length;
                for (var i = 0; i < accumulators.length; ++i) {
                    ret += accumulators[i];
                }
                return ret;
            })
        .reduce(function(accumulators, items) {
            var ret = items;
            for (var i = 0; i < accumulators.length; ++i) {
                ret = ret.concat(accumulators[i]);
            }
            ret.sort(function(a,b) { return b.value - a.value; });
            return ret.slice(0, 10);
        });
}
</script>
<script type="text/cq" id="top_email_providers_params">
{"params": {}}
</script>

<script type="text/cq" id="max_pixels_query">
function main() {
    return Events({}).reduce(
        function(accumulators, events) {
            var ret = { height : 0, width: 0, total: 0};
            for (var i = 0; i < accumulators.length; ++i) {
                if (accumulators[i].total > ret.total) {
                    ret = accumulators[i];
                }
            }
            for (var i = 0; i < events.length; ++i) {
                var w = events[i]["$screen_width"];
                var h = events[i]["$screen_height"];
                if (w * h > ret.total) {
                    ret = { height : h, width : w, total : w * h};
                }
            }
            return ret;
        });
}
</script>
<script type="text/cq" id="max_pixels_params">
{"params": {}}
</script>

<script type="text/cq" id="map_exception_query">
function main() {
    return Events({}).map(function(item) { throw "Hello!"; });
}
</script>
<script type="text/cq" id="map_exception_params">
{"params": {}}
</script>


</body>
</html>
